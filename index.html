<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>STWP â€” STWP Options Strategy Screener</title>

<style>
*{
    box-sizing: border-box;
}

/* GLOBAL */
body{
    font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial;
    background:#f5f6fa;
    margin:20px;
    color:#111;
}

h1{
    font-size:20px;
    font-weight:700;
    margin-bottom:4px;
}

.muted{
    color:#666;
    font-size:12px;
    margin-bottom:12px;
}

/* -------------- CLEAN UNIFORM INPUT ROW -------------- */
.row{
    display:flex;
    gap:12px;                    /* controlled spacing */
    align-items:flex-start;
    justify-content:flex-start;  /* keep left aligned */
    margin-bottom:10px;
    flex-wrap:wrap;
}

/* FINAL uniform sizing for all input boxes */
.box{
    display:flex;
    flex-direction:column;
    flex: 0 0 160px;   /* HARD LOCK spacing */
}

label{
    font-size:11px;
    font-weight:600;
    margin-bottom:2px;
}

/* FINAL uniform height + width for ALL inputs */
input, select{
    width:100%;
    height:22px;          
    padding:2px 6px;
    border:1px solid #cfd3da;
    border-radius:4px;
    font-size:11px;
    background:#fff;
}

/* Force file upload box to match same size */
#csvfile{
    width:100%;
    height:22px;
    padding:0 4px;
    font-size:10px;
}

input[type="file"]{
    font-size:11px;
    line-height:20px;
}

/* -------------- BUTTONS -------------- */
.strategy-box{
    background:#fff;
    padding:10px;
    border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
    margin-top:10px;
    margin-bottom:10px;
}

.strategy-btn{
    padding:6px 14px;
    border:0;
    cursor:pointer;
    border-radius:6px;
    font-size:13px;
    color:#fff;
    background:#0d6efd;
    font-weight:600;
    margin-right:8px;
}

/* WhatsApp button */
#waBtn{
    background:#25D366;
    color:#fff;
    padding:6px 12px;
    border-radius:6px;
    border:0;
    font-size:12px;
    font-weight:600;
    cursor:pointer;
    display:none;
}
#waBtn:hover{ background:#1eb45a; }

/* OUTPUT PANEL */
#outputBox{
    display:none;
    background:#ffffff;
    padding:12px 14px;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.10);
    font-size:12px;
    line-height:1.20;
    border-left:3px solid #0d6efd;
    margin-bottom:10px;
}

.output-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    column-gap:12px;
    row-gap:4px;
}

.section-title{
    font-weight:700;
    margin:2px 0;
    font-size:12px;
}
.stwp-disclaimer{
  margin-top:40px;
  padding:14px 16px;
  font-size:11px;
  line-height:1.5;
  color:#555;
  background:#ffffff;
  border-top:1px solid #e0e3ea;
}
/* ================================
   CSV TABLE VISUAL ENHANCEMENTS
================================ */

/* === OPTION TYPE ROW COLORS === */
tr.call-row { background:#f1fbf4; }
tr.put-row  { background:#fff2f2; }

/* === NUMERIC SIGNAL COLORS === */
.pos { color:#198754; font-weight:600; }
.neg { color:#dc3545; font-weight:600; }


/* ================================
   Buildup Classification Colors
================================ */

/* Base badge */
.badge {
  padding:2px 6px;
  border-radius:10px;
  font-size:10px;
  font-weight:600;
  white-space:nowrap;
}

/* Bullish */
.badge-long-build {
  background:#d1f0ee;   /* Teal */
  color:#055160;
}

.badge-short-cover {
  background:#d1e7dd;   /* Green */
  color:#0f5132;
}

/* Bearish */
.badge-short-build {
  background:#f8d7da;   /* Red */
  color:#842029;
}

.badge-long-unwind {
  background:#fff3cd;   /* Orange */
  color:#664d03;
}
/* ================================
   Delta Highlighting (ATM Proximity)
================================ */

.delta-strong {
  color:#198754;       /* Green */
  font-weight:700;
}

.delta-medium {
  color:#fd7e14;       /* Amber */
  font-weight:600;
}

</style>
</head>

<body>

<h1>STWP â€” Strategy Panel</h1>

<!-- SINGLE ROW INPUTS -->
<div class="row">

<div class="box">
<label>Upload CSV</label>
<div style="height:22px; display:flex; align-items:center;">
    <input id="csvfile" type="file" accept=".csv"/>
</div>
</div>

<div class="box">
<label>Select Symbol</label>
<select id="symbolSelect"><option>-- No symbols loaded --</option></select>
</div>

<div class="box">
<label>Spot</label>
<input id="spotInput" type="number">
</div>

<div class="box">
<label>Sentiment</label>
<select id="sentimentInput">
<option>Bullish</option>
<option>Bearish</option>
<option>Neutral</option>
</select>
</div>

<div class="box">
<label>Trend</label>
<select id="trendInput">
<option>Up</option>
<option>Down</option>
<option>Sideways</option>
</select>
</div>

<div class="box">
  <label>Expiry Date</label>
  <input id="expiryInput" type="date">
</div>

<div class="box">
  <label>DTE</label>
  <input id="dteInput" type="text" readonly
         style="font-weight:700; background:#eef1f6;">
</div>

<div class="box">
  <label>View</label>
  <input id="viewBox" type="text" readonly style="font-weight:700; background:#eef1f6;">
</div>

</div>

<div id="status" class="muted">No file uploaded yet.</div>

<!-- STRATEGY BUTTON -->
<div class="strategy-box">
<button class="strategy-btn" onclick="strategySelect('CALL')">CALL</button>
<button class="strategy-btn" style="background:#dc3545;" onclick="strategySelect('PUT')">PUT</button>
<button class="strategy-btn" style="background:#6f42c1;" onclick="strategySelect('STRADDLE')">STRADDLE</button>
<button class="strategy-btn" style="background:#198754;" onclick="strategySelect('STRANGLE')">STRANGLE</button>
<button class="strategy-btn" style="background:#0dcaf0;" onclick="strategySelect('BULL_SPREAD')">BULL SPREAD</button>
<button class="strategy-btn" style="background:#fd7e14;" onclick="strategySelect('BEAR_SPREAD')">BEAR SPREAD</button>
<button class="strategy-btn" style="background:#20c997;" onclick="strategySelect('IRON_CONDOR')">IRON CONDOR</button>
<button class="strategy-btn" style="background:#6c757d;" onclick="resetPanel()">RESET</button>


</div>

<!-- AUTO STRATEGY PANEL -->
<div id="autoStrategyBox" style="
display:none;
background:#ffffff;
padding:10px 14px;
border-left:4px solid #0d6efd;
border-radius:8px;
margin-top:10px;
box-shadow:0 2px 6px rgba(0,0,0,0.08);
font-size:13px;
font-weight:600;
">
</div>

<!-- OUTPUT -->
<div id="outputBox"></div>
<div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
    <button id="waBtn" onclick="exportWhatsApp()">Export WhatsApp Message</button>

    <button id="downloadBtn"
        onclick="downloadOptionChain()"
        style="
            background:#0d6efd;
            color:#fff;
            padding:6px 12px;
            border-radius:6px;
            border:0;
            font-size:12px;
            font-weight:600;
            cursor:pointer;
            display:none;
        ">
        Download Option Chain
    </button>
</div>

<div style="font-size:10px;color:#666;margin-top:6px;"> ðŸŸ© Directional OI | ðŸŸ§ Neutral / Spread | ðŸŸ¥ Defensive / Heat reflects net institutional conviction (price + OI + buildup)</b>, not trade recommendation. </div>

<script>

let fullCSVRows = [];
let spotColumnIndex = -1;
/* ---------------------------------------------------------
   STWP CONVICTION SCORE (NET PARTICIPATION LOGIC)
----------------------------------------------------------*/
function computeConvictionScore({ oiChgP, dayChg, buildup, trend }) {

  let score = 0;

  // Participation strength (log-scaled, avoids 100% saturation)
  if (oiChgP > 0) {
    score += Math.min(40, Math.log10(oiChgP + 1) * 20);
  }

  // Price confirmation
  if (dayChg > 0) score += 20;
  if (dayChg < 0) score -= 20;

  // Buildup interpretation
  const b = (buildup || "").toLowerCase();

  if (b.includes("long build"))  score += 25;
  if (b.includes("short cover")) score += 10;
  if (b.includes("short build")) score -= 25;
  if (b.includes("long unwind")) score -= 15;

  // Trend alignment
  if (trend === "Up"   && b.includes("long build"))  score += 20;
  if (trend === "Up"   && b.includes("short build")) score -= 20;
  if (trend === "Down" && b.includes("short build")) score += 20;
  if (trend === "Down" && b.includes("long build"))  score -= 20;

  return Math.max(-100, Math.min(100, score));
}

/* ---------------------------------------------------------
   HEAT BAR FROM CONVICTION (NOT SENTIMENT)
----------------------------------------------------------*/
function buildHeatBarFromConviction(score) {

  const blocks = 10;
  const filled = Math.round(Math.abs(score) / 10);

  let color = "ðŸŸ§";           // Neutral
  if (score > 20)  color = "ðŸŸ©"; // Supportive
  if (score < -20) color = "ðŸŸ¥"; // Opposing / Capping

  return {
    bar: color.repeat(filled) + "â¬œ".repeat(blocks - filled),
    pct: Math.abs(score)
  };
}

/* ---------------------------------------------------------
          BUILDUP HEAT BAR (10 COLOR BLOCKS)
----------------------------------------------------------*/
function buildHeatBar(oiChgP, sentiment) {

  const heat = Math.max(0, Math.min(100, (oiChgP / 60) * 100));

  const blocks = 10;
  const filled = Math.round((heat / 100) * blocks);

  let color = "ðŸŸ§"; // neutral
  if (sentiment === "Bullish") color = "ðŸŸ©";
  if (sentiment === "Bearish") color = "ðŸŸ¥";

  const empty = "â¬œ";

  return {
    bar: color.repeat(filled) + empty.repeat(blocks - filled),
    pct: Math.round(heat)
  };
}

/* ---------------------------------------------------------
   SPREAD BUILDUP HEAT (NET POSITIONING)
----------------------------------------------------------*/
function buildSpreadHeat(buyOI, sellOI) {

  const netOI = (buyOI || 0) - (sellOI || 0);

  // Neutral sentiment for spreads
  return buildHeatBar(netOI, "Neutral");
}

/* CSV PARSER */
function parseCSV(text){
const rows=[]; let cur='', row=[], inQuotes=false;
for(let i=0;i<text.length;i++){
const ch=text[i], nxt=text[i+1];
if(ch==='"'){ if(inQuotes && nxt==='"'){cur+='"';i++;continue;} inQuotes=!inQuotes;continue; }
if(!inQuotes && (ch==='\n'||ch==='\r')){
if(cur!==''||row.length){row.push(cur);rows.push(row);row=[];cur='';}
if(ch==='\r'&&nxt==='\n')i++;
continue;
}
if(!inQuotes && ch===','){row.push(cur);cur='';continue;}
cur+=ch;
}
if(cur!==''||row.length){row.push(cur);rows.push(row);}
return rows;
}

function mapHeader(headerRow){
const cleaned=headerRow.map(h=> (h||'').toString().trim().replace(/[^a-z0-9]/gi,'').toLowerCase());
return {
getIndex(patterns){
for(const p of patterns){
const key=p.toLowerCase().replace(/[^a-z0-9]/gi,'');
const idx=cleaned.findIndex(h=>h===key);
if(idx>=0) return idx;
}
return -1;
}
};
}

document.getElementById('csvfile').addEventListener('change', e=>{
const f=e.target.files?.[0];
if(!f){document.getElementById('status').textContent="No file selected.";return;}

const reader=new FileReader();
reader.onload=ev=>{
const rows=parseCSV(ev.target.result);
fullCSVRows=rows;

const header=rows[0].map(h=>h.trim());
const mapper=mapHeader(header);

spotColumnIndex = mapper.getIndex(['spot']);

const symbols=[...new Set(rows.slice(1).map(r=> (r[0]||'').trim().toUpperCase()))].sort();
const sel=document.getElementById('symbolSelect');

sel.innerHTML='<option value="">-- Select --</option>';
symbols.forEach(s=>{
const op=document.createElement('option');
op.value=s; op.textContent=s; sel.appendChild(op);
});

document.getElementById('status').textContent="Symbols loaded.";
};
reader.readAsText(f);
});

document.getElementById('symbolSelect').addEventListener('change',()=>{
  const selected=document.getElementById('symbolSelect').value;
  const spotInput=document.getElementById('spotInput');
  renderCSVTable(selected);

  if(!selected){
    spotInput.value='';
    document.getElementById("viewBox").value = "";
    return;
  }

  for(let i=1;i<fullCSVRows.length;i++){
    const row=fullCSVRows[i];
    if((row[0]||'').trim().toUpperCase()===selected){
      spotInput.value=row[spotColumnIndex]||'';
      break;
    }
  }

  // ðŸ”‘ NOW spot exists â†’ compute AUTO VIEW
  refreshViewBox();
});

/* HELPERS */
function toNumber(v){
if(v==null) return null;
const s=String(v).replace(/,/g,'').trim();
if(!s) return null;
const n=parseFloat(s);
return isNaN(n)?null:n;
}
/* =====================================
   DTE-BASED STRIKE USABILITY FILTER
===================================== */
function isStrikeUsableByDTE({ delta, DTE }) {

  if(delta == null || DTE == null) return true; // fail-safe

  const ad = Math.abs(delta);

  if(DTE <= 1){
    return ad >= 0.50;       // ATM / ITM only
  }

  if(DTE <= 3){
    return ad >= 0.45;
  }

  if(DTE <= 7){
    return ad >= 0.40;
  }

  return ad >= 0.30;
}

/* GET CALL ROWS */
function getCallRows(symbol){
return fullCSVRows.slice(1).map(r=>({
Symbol:(r[0]||"").trim(),
Type:(r[1]||"").toUpperCase(),
Strike:toNumber(r[2]),
LTP:toNumber(r[3]),
DayChg:toNumber(r[4]),
Vol:toNumber(r[5]),
VolChg:toNumber(r[6]),
OI:toNumber(r[8]),
OIChg:toNumber(r[9]),
OIChgP:toNumber(r[10]),
IV:toNumber(r[11]),
IVChgP:toNumber(r[12]),
Spot:toNumber(r[13]),
Delta:toNumber(r[14]),
Gamma:toNumber(r[15]),
Rho:toNumber(r[16]),
Theta:toNumber(r[17]),
Vega:toNumber(r[18]),
Buildup:(r[19]||"")
}))
.filter(r=> r.Symbol===symbol && (r.Type==="CE"||r.Type==="CALL"));
}

/* GET PUT ROWS */
function getPutRows(symbol){
return fullCSVRows.slice(1).map(r=>({
Symbol:(r[0]||"").trim(),
Type:(r[1]||"").toUpperCase(),
Strike:toNumber(r[2]),
LTP:toNumber(r[3]),
DayChg:toNumber(r[4]),
Vol:toNumber(r[5]),
VolChg:toNumber(r[6]),
OI:toNumber(r[8]),
OIChg:toNumber(r[9]),
OIChgP:toNumber(r[10]),
IV:toNumber(r[11]),
IVChgP:toNumber(r[12]),
Spot:toNumber(r[13]),
Delta:toNumber(r[14]),
Gamma:toNumber(r[15]),
Rho:toNumber(r[16]),
Theta:toNumber(r[17]),
Vega:toNumber(r[18]),
Buildup:(r[19]||"")
}))
.filter(r=> r.Symbol===symbol && (r.Type==="PE"||r.Type==="PUT"));
}

/* CLOSEST STRIKE */
function closestToSpot(list, spot){
let best=list[0];
let diff=Math.abs(list[0].Strike - spot);
list.forEach(r=>{
const d=Math.abs(r.Strike - spot);
if(d<diff){diff=d;best=r;}
});
return best;
}

/* EDGE SCORE */
function computeEdgeScore(row, atmStrike){
const delta = Math.abs(row.Delta);
const oi = row.OIChgP;
const vol = row.VolChg;
const iv = row.IV;
const ivc = row.IVChgP;
const strike=row.Strike;
const buildup=String(row.Buildup||"").toLowerCase();

let deltaComp=4;
if(delta!=null){
const dist=Math.abs(delta - 0.45);
const norm=Math.max(0,1 - dist/0.45);
deltaComp = 2 + norm*8;
}

function momentum(x){
if(x==null) return 0;
const c=Math.max(-30,Math.min(60,x));
if(c<=0) return 0;
return (c/60)*10;
}

const oiComp=momentum(oi);
const volComp=momentum(vol);
const oiVolComp=Math.min(10,(oiComp*0.6 + volComp*0.4));

let buildRaw=0;
if(buildup.includes("long build")) buildRaw+=3;
if(buildup.includes("short cover")) buildRaw+=2;
if(buildup.includes("short build")) buildRaw-=3;

const buildupComp=Math.max(0,Math.min(10,5 + buildRaw*1.5));

let ivComp=5;
if(iv!=null){
if(iv<15) ivComp-=1;
else if(iv>35) ivComp-=2;
}

if(ivc!=null){
if(ivc>5) ivComp+=2;
else if(ivc<-5) ivComp-=2;
}

let atmComp=5;
if(atmStrike!=null && strike!=null){
const dist=Math.abs(strike - atmStrike);
const maxDist=Math.max(1,atmStrike*0.05);
const norm=Math.max(0,1 - dist/maxDist);
atmComp = 2 + norm*8;
}

return deltaComp*0.30 + oiVolComp*0.30 + buildupComp*0.20 + ivComp*0.10 + atmComp*0.10;
}

function decideBestView(context){
const {
  trend, sentiment,
  ivAvg, expMovePct,
  totalPremPct,
  netDelta,
  DTE
} = context;
// ===============================
// DTE HARD FILTERS (INSTITUTIONAL)
// ===============================
if(DTE <= 1){
  return "OBSERVE ONLY â€” Gamma Risk High";
}

if(DTE <= 3 && (ivAvg > 28)){
  return "AVOID LONG PREMIUM â€” IV + Gamma Risk";
}

// Safety
if(ivAvg == null || expMovePct == null){
  return "DATA INSUFFICIENT";
}
// ===============================
// STRATEGY TIME SUITABILITY
// ===============================

// Long volatility needs time
if((DTE <= 3) && (trend === "Sideways")){
  return "STRADDLE / STRANGLE NOT ADVISED â€” Time Insufficient";
}

// Income structures need decay window
if(DTE < 5){
  // Blocks Iron Condor & heavy theta plays
  if(trend === "Sideways"){
    return "NO THETA EDGE â€” EXPIRY TOO NEAR";
  }
}

// Naked directional too risky very late
if(DTE <= 1 && (sentiment !== "Neutral")){
  return "DIRECTIONAL GAMMA RISK â€” AVOID";
}

// ===============================
// STRONG DIRECTIONAL CONDITIONS
// ===============================
if(sentiment === "Bullish" && trend === "Up"){
  if(ivAvg < 22) return "CALL";
  return "BULL SPREAD";
}

if(sentiment === "Bearish" && trend === "Down"){
  if(ivAvg < 22) return "PUT";
  return "BEAR SPREAD";
}

// ===============================
// VOLATILITY EXPANSION
// ===============================
if(trend === "Sideways"){
  if(expMovePct >= totalPremPct){
    if(ivAvg < 20) return "STRADDLE";
    return "STRANGLE";
  }
}

// ===============================
// RANGE / THETA STRUCTURE
// ===============================
if(trend === "Sideways" && ivAvg > 25 && Math.abs(netDelta) < 0.10){
  return "IRON CONDOR";
}

// ===============================
// FALLBACK
// ===============================
return "NO CLEAR EDGE";
}

/* =====================================
   AUTO STRUCTURE DECISION ENGINE
===================================== */

function decideAutoStructure(context){

  const {
    trend,
    sentiment,
    ivAvg,
    expMovePct,
    totalPremPct,
    netDelta,
    DTE
  } = context;

  if(ivAvg == null || expMovePct == null){
    return {structure:"NO CLEAR EDGE", confidence:"Low"};
  }

  // Late expiry protection
  if(DTE <= 1){
    return {structure:"OBSERVE ONLY â€” Gamma Risk", confidence:"Low"};
  }

  // Directional bullish
  if(sentiment === "Bullish" && trend === "Up"){
      if(ivAvg < 22)
        return {structure:"LONG CALL", confidence:"High"};

      return {structure:"BULL CALL SPREAD", confidence:"High"};
  }

  // Directional bearish
  if(sentiment === "Bearish" && trend === "Down"){
      if(ivAvg < 22)
        return {structure:"LONG PUT", confidence:"High"};

      return {structure:"BEAR PUT SPREAD", confidence:"High"};
  }

  // Volatility regime
  if(trend === "Sideways"){

      if(expMovePct > totalPremPct){
          if(ivAvg < 20)
            return {structure:"STRADDLE", confidence:"High"};

          return {structure:"STRANGLE", confidence:"Moderate"};
      }

      if(ivAvg > 25){
        return {structure:"IRON CONDOR", confidence:"Moderate"};
      }
  }

  return {structure:"CONDITIONAL â€” WAIT", confidence:"Low"};
}

/* =====================================
   TRADEABILITY SCORE ENGINE
===================================== */

function computeTradeability({
    edge,
    ivAvg,
    trend,
    expMovePct,
    totalPremPct,
    DTE
}){

    let score = 0;

    // EDGE (0â€“3)
    if(edge >= 7) score += 3;
    else if(edge >= 5) score += 2;
    else score += 1;

    // IV Suitability (0â€“2)
    if(ivAvg >= 18 && ivAvg <= 32) score += 2;
    else if(ivAvg < 40) score += 1;

    // Regime Stability (0â€“2)
    if(trend !== "Sideways") score += 2;
    else if(expMovePct >= totalPremPct * 0.9) score += 1;

    // Time Quality (0â€“2)
    if(DTE >= 5 && DTE <= 25) score += 2;
    else if(DTE > 2) score += 1;

    // Premium Efficiency (0â€“1)
    if(expMovePct >= totalPremPct) score += 1;

    return Math.min(10, score);
}

function tradeabilityLabel(score){

    if(score >= 8) return {
        text:"Institutional Grade",
        color:"#198754"
    };

    if(score >= 6) return {
        text:"Tradable with Discipline",
        color:"#fd7e14"
    };

    if(score >= 4) return {
        text:"Conditional",
        color:"#6c757d"
    };

    return {
        text:"Observe Only",
        color:"#dc3545"
    };
}

function autoComputeViewOnSymbolSelect(symbol, spot, sentiment, trend){

  const callRows = getCallRows(symbol);
  const putRows  = getPutRows(symbol);

  if(!callRows.length || !putRows.length){
    return "";
  }

  const atmCall = closestToSpot(callRows, spot);
  const atmPut  = closestToSpot(putRows, spot);

  const totalPremium = (atmCall.LTP || 0) + (atmPut.LTP || 0);
  const totalPremPct = (totalPremium / spot) * 100;

  const ivAvg = (
    (atmCall.IV != null ? atmCall.IV : 0) +
    (atmPut.IV  != null ? atmPut.IV  : 0)
  ) / 2;

  const netDelta =
    (atmCall.Delta || 0) +
    (atmPut.Delta  || 0);

  const DTE = calculateDTE(
  document.getElementById("expiryInput").value
) || 0;

  const expMovePct = ivAvg > 0
    ? (ivAvg/100) * Math.sqrt(DTE/365) * 100
    : null;

  return decideBestView({
  trend,
  sentiment,
  ivAvg,
  expMovePct,
  totalPremPct,
  netDelta,
  DTE
});
}

/* =====================================
   AUTO STRATEGY RENDER
===================================== */

function renderAutoStrategy(structure, confidence, tradeLabel, tradeScore){

  const box = document.getElementById("autoStrategyBox");

  let confColor = "#6c757d";

  if(confidence === "High") confColor = "#198754";
  if(confidence === "Moderate") confColor = "#fd7e14";

  box.style.display = "block";

  box.innerHTML = `
    <div style="font-size:13px;font-weight:700;">
        Preferred Institutional Structure:
        <span style="margin-left:6px;">${structure}</span>
        <span style="color:${confColor};margin-left:6px;">
            (${confidence})
        </span>
    </div>

    <div style="
        margin-top:6px;
        font-size:12px;
        font-weight:600;
        color:${tradeLabel.color};
    ">
        Tradeability Score: ${tradeScore}/10 â€” ${tradeLabel.text}
    </div>
  `;
}

function refreshViewBox(){

  const symbol    = document.getElementById("symbolSelect").value;
  const spot      = parseFloat(document.getElementById("spotInput").value);
  const sentiment = document.getElementById("sentimentInput").value;
  const trend     = document.getElementById("trendInput").value;
  const expiry    = document.getElementById("expiryInput").value;

  const viewBox = document.getElementById("viewBox");

  // Mandatory inputs for a valid View
  if(!symbol || !spot || !expiry){
    viewBox.value = "";
    return;
  }

  const DTE = calculateDTE(expiry);
  if(DTE == null){
    viewBox.value = "";
    return;
  }

  const callRows = getCallRows(symbol);
const putRows  = getPutRows(symbol);

if(!callRows.length || !putRows.length){
    viewBox.value = "";
    return;
}

const atmCall = closestToSpot(callRows, spot);
const atmPut  = closestToSpot(putRows, spot);

const totalPremium = (atmCall.LTP || 0) + (atmPut.LTP || 0);
const totalPremPct = (totalPremium / spot) * 100;

const ivAvg = ((atmCall.IV || 0) + (atmPut.IV || 0)) / 2;
const netDelta = (atmCall.Delta || 0) + (atmPut.Delta || 0);

const expMovePct = ivAvg > 0
  ? (ivAvg/100) * Math.sqrt(DTE/365) * 100
  : null;

const decision = decideAutoStructure({
    trend,
    sentiment,
    ivAvg,
    expMovePct,
    totalPremPct,
    netDelta,
    DTE
});

// Use ATM edge as proxy
const edgeProxy = (
    computeEdgeScore(atmCall, atmCall.Strike) +
    computeEdgeScore(atmPut, atmPut.Strike)
) / 2;

const tradeScore = computeTradeability({
    edge: edgeProxy,
    ivAvg,
    trend,
    expMovePct,
    totalPremPct,
    DTE
});

const tradeLabel = tradeabilityLabel(tradeScore);


renderAutoStrategy(
    decision.structure,
    decision.confidence,
    tradeLabel,
    tradeScore
);

viewBox.value = decision.structure;

}

function downloadOptionChain(){

  if(!fullCSVRows || !fullCSVRows.length){
    alert("No CSV loaded.");
    return;
  }

  const selected = document.getElementById("symbolSelect").value;

  // Convert rows back to CSV
  const rows = fullCSVRows
    .filter((r,i)=> i===0 || !selected || (r[0]||"").toUpperCase()===selected);

  const csvContent = rows.map(r => r.join(",")).join("\n");

  const blob = new Blob([csvContent], {type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = selected 
      ? `${selected}_OptionChain.csv`
      : "OptionChain.csv";

  a.click();
  URL.revokeObjectURL(url);
}


function resetPanel(){

  // Reset dropdowns & inputs
  document.getElementById('symbolSelect').value = "";
  document.getElementById('spotInput').value = "";
  document.getElementById('sentimentInput').value = "Bullish";
  document.getElementById('trendInput').value = "Up";
  document.getElementById('viewBox').value = "";
  document.getElementById("autoStrategyBox").style.display = "none";

  // Clear output
  document.getElementById('outputBox').style.display = "none";
  document.getElementById('outputBox').innerHTML = "";

  // Hide WhatsApp button
  document.getElementById('waBtn').style.display = "none";
  document.getElementById('downloadBtn').style.display = "none";


  // Clear stored analysis
  window.lastData = null;

  // Optional status feedback
  document.getElementById('status').textContent =
    "Panel reset. Select a symbol to begin.";
}

/* =====================================================
   STWP DESK INTELLIGENCE â€” PHASE 3 (OBSERVATION MODE)
===================================================== */

function computeMarketRegime({ trend, ivAvg, expMovePct, totalPremPct }) {

  if(ivAvg == null || expMovePct == null){
    return "Undefined (Insufficient Data)";
  }

  if(trend !== "Sideways" && ivAvg < 22 && expMovePct >= totalPremPct * 0.9){
    return "Directional Expansion";
  }

  if(trend === "Sideways" && ivAvg < 18){
    return "Volatility Compression";
  }

  if(trend === "Sideways" && ivAvg > 25 && expMovePct < totalPremPct){
    return "Range with Elevated Premium";
  }

  if(trend !== "Sideways" && ivAvg >= 22 && ivAvg <= 30){
    return "Transition / Repricing Phase";
  }

  return "Mixed / No Clear Regime";
}

function computeActionBias(edge, regime){
  if(edge >= 7 && !regime.includes("Mixed")) return "Tradable Structure";
  if(edge >= 5) return "Conditional â€” Wait for Confirmation";
  return "Observe Only â€” No Edge";
}

function computeConviction(edge, actionBias){
  if(edge >= 7.5 && actionBias === "Tradable Structure")
    return "High Conviction";
  if(edge >= 5.5)
    return "Medium Conviction";
  return "Low Conviction";
}

function computeRegimeStability({ ivAvg, trend, expMovePct, totalPremPct }){
  let score = 0;

  if(trend !== "Sideways") score += 2;
  if(ivAvg >= 18 && ivAvg <= 28) score += 2;
  if(expMovePct >= totalPremPct * 0.8) score += 1;

  if(score >= 4) return "Stable";
  if(score >= 2) return "Moderately Stable";
  return "Fragile";
}

function computeExpiryContext(DTE){
  if(DTE <= 2) return "Late-expiry â€” gamma sensitive";
  if(DTE <= 5) return "Mid-expiry â€” balanced gamma & theta";
  return "Early-expiry â€” volatility positioning";
}

function buildUpContextLine({ trend, optionType, buildup }){

  const b = (buildup || "").toLowerCase();

  /* ===============================
        CALL CONTEXT (CLEAN)
   =============================== */
if(optionType === "CALL"){

  // --- LONG UNWINDING ---
  if(b.includes("long unwind")){
    return trend === "Up"
      ? "Context: Call long unwinding â€” profit booking or momentum fatigue."
      : "Context: Call long unwinding â€” bullish structure weakening.";
  }

  // --- LONG BUILD-UP ---
  if(b.includes("long build")){
    return trend === "Up"
      ? "Context: Calls seeing fresh longs â€” trend continuation well supported."
      : "Context: Call longs building against trend â€” higher risk momentum bet.";
  }

  // --- SHORT COVERING ---
  if(b.includes("short cover")){
    return trend === "Up"
      ? "Context: Call short covering â€” bullish acceleration risk present."
      : "Context: Call short covering â€” relief rally or bounce risk.";
  }

  // --- SHORT BUILD-UP (CALL WRITING) ---
  if(b.includes("short build")){
    return trend === "Up"
      ? "Context: Call writing seen despite uptrend â€” upside may remain capped unless price expands decisively."
      : "Context: Call writing aligned with downtrend â€” upside pressure contained.";
  }
}

 /* ===============================
        PUT CONTEXT (CLEAN)
   =============================== */
if(optionType === "PUT"){

  // --- LONG UNWINDING ---
  if(b.includes("long unwind")){
    return trend === "Down"
      ? "Context: Put long unwinding â€” profit booking after downside move."
      : "Context: Put long unwinding in non-bearish trend â€” downside protection being reduced.";
  }

  // --- LONG BUILD-UP ---
  if(b.includes("long build")){
    return trend === "Down"
      ? "Context: Fresh put longs â€” downside continuation supported."
      : "Context: Put longs building against trend â€” hedge demand or caution positioning.";
  }

  // --- SHORT COVERING ---
  if(b.includes("short cover")){
    return trend === "Down"
      ? "Context: Put short covering â€” bearish momentum cooling."
      : "Context: Put short covering in non-bearish trend â€” downside protection being unwound, bullish confidence improving.";
  }

  // --- SHORT BUILD-UP (PUT WRITING) ---
  if(b.includes("short build")){
    return trend === "Down"
      ? "Context: Put writing against downtrend â€” downside may pause."
      : "Context: Put writing in non-bearish trend â€” downside risk perceived as limited.";
  }
}

  return null;
}

function renderDeskIntelligence(ctx){
  return `
  <div style="
      margin-bottom:10px;
      padding:10px 12px;
      border-left:3px solid #343a40;
      background:#f8f9fb;
      border-radius:6px;
      font-size:12px;
      line-height:1.35;
  ">
    <b>STWP Desk Intelligence</b>
    <span style="color:#666;font-size:11px">(Beta Â· Observation)</span><br><br>

    <b>Market Regime:</b> ${ctx.regime}<br>
    <b>Action Bias:</b> ${ctx.actionBias}<br>
    <b>Conviction Level:</b> ${ctx.conviction}<br>
    <b>Regime Stability:</b> ${ctx.stability}<br>
    <b>Expiry Context:</b> ${ctx.expiry}<br>

    <span style="font-size:11px;color:#666">
      Contextual layer only. Does not alter strategy output.
    </span>
  </div>
  `;
}

function computeSTWPFinalAnalysis({ edge, trend, oiChg, iv }) {

  let momentum, risk, volatility, institutional, tactical;

  // Momentum
  if(edge >= 7) momentum = "Strong";
  else if(edge >= 5) momentum = "Early but unconfirmed";
  else momentum = "Weak";

  // Risk
  if(oiChg > 5) risk = "Lower (participation expanding)";
  else if(oiChg < 0) risk = "Moderate (OI contraction)";
  else risk = "Neutral";

  // Volatility
  if(iv < 18) volatility = "Lowâ€“Stable";
  else if(iv < 30) volatility = "Healthy";
  else volatility = "Elevated";

  // Institutional read
  if(oiChg > 0) institutional = "Fresh positioning observed";
  else institutional = "Repositioning / short covering";

  // Tactical view
  if(edge >= 6.5)
    tactical = "Momentum continuation can be explored on strength";
  else
    tactical = "Prefer confirmation before commitment";

  return `
Momentum: ${momentum} | Trend: ${trend}<br>
Risk: ${risk} | Volatility: ${volatility}<br>
Institutional Read: ${institutional}<br>
Tactical View: ${tactical}
  `;
}


/* STRATEGY ENGINE */
function strategySelect(name){

const outputBox=document.getElementById('outputBox');
const waBtn=document.getElementById('waBtn');

const symbol=document.getElementById('symbolSelect').value;
const spot=parseFloat(document.getElementById('spotInput').value);
const sentiment=document.getElementById('sentimentInput').value;
const trend=document.getElementById('trendInput').value;

if(!symbol){alert("Select symbol");return;}
if(!spot){alert("Enter spot");return;}

/* ===============================
          CALL LOGIC
   =============================== */
if(name==="CALL"){

const rows=getCallRows(symbol);
if(!rows.length){alert("No CALL rows found");return;}

const atm=closestToSpot(rows,spot);
const DTE = calculateDTE(
  document.getElementById("expiryInput").value
) || 0;
// ===============================
// DTE STRIKE USABILITY CHECK
// ===============================
if(!isStrikeUsableByDTE({ delta: atm.Delta, DTE })){

  outputBox.style.display = "block";
  outputBox.innerHTML = `
    <div style="
      background:#fff3cd;
      padding:12px;
      border-radius:6px;
      font-size:12px;
      border-left:3px solid #fd7e14;
    ">
      <b>STRIKE FILTERED BY TIME</b><br>
      Selected CALL strike is not suitable for the current expiry window.<br>
      <i>High theta / gamma risk due to low DTE.</i>
    </div>
  `;
  return;
}
const intraday=atm;
const swingList=rows.filter(r=>r.Delta>=0.48 && r.Delta<=0.52);
const swing=swingList.length? closestToSpot(swingList,spot) : atm;

const edge=computeEdgeScore(atm,atm.Strike);
const quality=edge>=6.5?"Strong":edge>=4?"Moderate":"Weak";
// ===== DESK INTELLIGENCE (CALL) =====
const ivAvg = atm.IV;
const expMovePct = ivAvg > 0
  ? (ivAvg/100) * Math.sqrt(DTE/365) * 100
  : null;

const totalPremPct = (atm.LTP / spot) * 100;

const regime = computeMarketRegime({
  trend, ivAvg, expMovePct, totalPremPct
});

const actionBias = computeActionBias(edge, regime);
const conviction = computeConviction(edge, actionBias);
const stability = computeRegimeStability({
  ivAvg, trend, expMovePct, totalPremPct
});
const expiry = computeExpiryContext(DTE);

const deskHTML = renderDeskIntelligence({
  regime,
  actionBias,
  conviction,
  stability,
  expiry
});


/* Heat bar */
const convictionScore = computeConvictionScore({
  oiChgP: atm.OIChgP,
  dayChg: atm.DayChg,
  buildup: atm.Buildup,
  trend
});

const heat = buildHeatBarFromConviction(convictionScore);

const summary=[];
summary.push(`Setup aligns with a ${sentiment.toLowerCase()} bias and ${trend.toLowerCase()} structure.`);
summary.push(edge>=6.5?`Strong institutional alignment.`:edge>=4?`Moderate, tradable with discipline.`:`Weak â€” watchlist only.`);
if(atm.DayChg > 0 && atm.OIChgP > 0)  summary.push("Price â†‘ + OI â†‘ â€” long build-up / continuation.");

if(atm.DayChg > 0 && atm.OIChgP < 0)  summary.push("Price â†‘ + OI â†“ â€” short covering.");

if(atm.DayChg < 0 && atm.OIChgP > 0)  summary.push("Price â†“ + OI â†‘ â€” short build-up (fresh shorts).");

if(atm.DayChg < 0 && atm.OIChgP < 0)  summary.push("Price â†“ + OI â†“ â€” long unwinding / distribution.");

const contextLine = buildUpContextLine({
  trend,
  optionType: "CALL",
  buildup: atm.Buildup
});

const finalAnalysis = computeSTWPFinalAnalysis({
  edge,
  trend,
  oiChg: atm.OIChgP,
  iv: atm.IV
});

const finalHTML = `
<div style="
  background:#ffffff;
  padding:12px 14px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  font-size:12px;
  line-height:1.4;
">

<b>SYMBOL:</b> ${symbol} |
<b>SPOT:</b> ${spot} |
<b>SENTIMENT:</b> ${sentiment} |
<b>TREND:</b> ${trend}<br>

<b>EDGE:</b> ${edge.toFixed(1)} / 10 (${quality}) |
<b>STRUCTURE:</b> Directional

<hr>

<b>STRIKES â†’</b>
ATM ${atm.Strike} (${atm.LTP}) |
INTRADAY ${intraday.Strike} (${intraday.LTP}) |
SWING ${swing.Strike} (${swing.LTP})

<hr>

<b>INTERPRETATION â†’</b>
Î” ${atm.Delta} |
OI ${atm.OIChgP}% |
VOL ${atm.VolChg}% |
IV ${atm.IV}% |
Buildup: ${atm.Buildup || "n/a"}

<hr>

<b>SUMMARY â†’</b>
${summary.join(" | ")}

<hr>

<b>STWP FINAL ANALYSIS â†’</b><br>
${finalAnalysis}

<hr>

<b>STWP NOTE â†’</b>
Heat: ${heat.bar} ${heat.pct}% |
Watchlist unless momentum expands
${contextLine ? `<br><i style="color:#555;font-size:11px;">${contextLine}</i>` : ""}

</div>
`;

outputBox.style.display="block";
outputBox.innerHTML = deskHTML + finalHTML;

window.lastData = {
symbol,
spot,
sentiment,
trend,
edge: edge.toFixed(1),
quality,
atmStrike: atm.Strike,
atmLTP: atm.LTP,
intraStrike: intraday.Strike,
intraLTP: intraday.LTP,
swingStrike: swing.Strike,
swingLTP: swing.LTP,
summary,
delta: atm.Delta,
oi: atm.OIChgP,
vol: atm.VolChg,
iv: atm.IV,
type:"CALL",
heatBar: heat.bar,
heatPct: heat.pct,
buildup: atm.Buildup
};

document.getElementById("viewBox").value =
  (sentiment === "Bullish" && trend === "Up")
    ? "CALL / BULL SPREAD"
    : "CALL (WEAK CONTEXT)";

waBtn.style.display="inline-block";
document.getElementById("downloadBtn").style.display = "inline-block";
}


/* ===============================
          PUT LOGIC
   =============================== */
if(name === "PUT"){

const rows = getPutRows(symbol);
if(!rows.length){ alert("No PUT rows found"); return; }

const atm = closestToSpot(rows, spot);
const DTE = calculateDTE(
  document.getElementById("expiryInput").value
) || 0;
// ===============================
// DTE STRIKE USABILITY CHECK
// ===============================
if(!isStrikeUsableByDTE({ delta: atm.Delta, DTE })){

  outputBox.style.display = "block";
  outputBox.innerHTML = `
    <div style="
      background:#fff3cd;
      padding:12px;
      border-radius:6px;
      font-size:12px;
      border-left:3px solid #fd7e14;
    ">
      <b>STRIKE FILTERED BY TIME</b><br>
      Selected PUT strike is not suitable for the current expiry window.<br>
      <i>High theta / gamma risk due to low DTE.</i>
    </div>
  `;
  return;
}
const intraday = atm;
const swingList = rows.filter(r => r.Delta <= -0.48 && r.Delta >= -0.52);
const swing = swingList.length ? closestToSpot(swingList, spot) : atm;

const edge = computeEdgeScore(atm, atm.Strike);
const quality = edge >= 6.5 ? "Strong" : edge >= 4 ? "Moderate" : "Weak";

/* ===== DESK INTELLIGENCE (PUT) ===== */
const ivAvg = atm.IV;
const expMovePct = ivAvg > 0
  ? (ivAvg / 100) * Math.sqrt(DTE / 365) * 100
  : null;

const totalPremPct = (atm.LTP / spot) * 100;

const regime = computeMarketRegime({
  trend, ivAvg, expMovePct, totalPremPct
});

const actionBias = computeActionBias(edge, regime);
const conviction = computeConviction(edge, actionBias);
const stability = computeRegimeStability({
  ivAvg, trend, expMovePct, totalPremPct
});
const expiry = computeExpiryContext(DTE);

const deskHTML = renderDeskIntelligence({
  regime,
  actionBias,
  conviction,
  stability,
  expiry
});

/* ===== HEAT BAR ===== */
const convictionScore = computeConvictionScore({
  oiChgP: atm.OIChgP,
  dayChg: atm.DayChg,
  buildup: atm.Buildup,
  trend
});

const heat = buildHeatBarFromConviction(convictionScore);

/* ===== SUMMARY (PRICEâ€“OI LOGIC) ===== */
const summary = [];
summary.push(`Setup aligns with a ${sentiment.toLowerCase()} bias and ${trend.toLowerCase()} structure.`);
summary.push(  quality === "Strong"    ? "Strong quality setup"    : quality === "Moderate"      ? "Moderate quality"      : "Weak quality â€” watchlist only");

if(atm.DayChg > 0 && atm.OIChgP > 0)
  summary.push("Price â†‘ + OI â†‘ â€” long build-up (bullish participation, against PUT bias)");

if(atm.DayChg > 0 && atm.OIChgP < 0)
  summary.push("Price â†‘ + OI â†“ â€” short covering (bearish pressure easing)");

if(atm.DayChg < 0 && atm.OIChgP > 0)
  summary.push(
    trend === "Down"
      ? "Price â†“ + OI â†‘ â€” trend-aligned short build-up"
      : "Price â†“ + OI â†‘ â€” counter-trend short build-up"
  );

if(atm.DayChg < 0 && atm.OIChgP < 0)
  summary.push("Price â†“ + OI â†“ â€” long unwinding / downside exhaustion risk");
const contextLine = buildUpContextLine({
  trend,
  optionType: "PUT",
  buildup: atm.Buildup
});


/* ===== FINAL ANALYSIS ===== */
const finalAnalysis = computeSTWPFinalAnalysis({
  edge,
  trend,
  oiChg: atm.OIChgP,
  iv: atm.IV
});

/* ===== HORIZONTAL OUTPUT ===== */
const finalHTML = `
<div style="
  background:#ffffff;
  padding:12px 14px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  font-size:12px;
  line-height:1.4;
">

<b>SYMBOL:</b> ${symbol} |
<b>SPOT:</b> ${spot} |
<b>SENTIMENT:</b> ${sentiment} |
<b>TREND:</b> ${trend}<br>

<b>EDGE:</b> ${edge.toFixed(1)} / 10 (${quality}) |
<b>STRUCTURE:</b> Directional

<hr>

<b>STRIKES â†’</b>
ATM: ${atm.Strike} (${atm.LTP}) |
INTRADAY: ${intraday.Strike} (${intraday.LTP}) |
SWING: ${swing.Strike} (${swing.LTP})

<hr>

<b>INTERPRETATION â†’</b>
Î” ${atm.Delta} |
OI ${atm.OIChgP}% |
VOL ${atm.VolChg}% |
IV ${atm.IV}% |
Buildup: ${atm.Buildup || "Short Build-up"}

<hr>

<b>SUMMARY â†’</b><br>
${summary.join(" | ")}

<hr>

<b>STWP FINAL ANALYSIS â†’</b><br>
${finalAnalysis}

<hr>

<b>STWP NOTE â†’</b>
Heat: ${heat.bar} ${heat.pct}% |
Directional follow-through favored
${contextLine ? `<br><i style="font-size:11px;color:#555;">${contextLine}</i>` : ""}

</div>
`;

outputBox.style.display = "block";
outputBox.innerHTML = deskHTML + finalHTML;

/* ===== STORE FOR WHATSAPP ===== */
window.lastData = {
  symbol,
  spot,
  sentiment,
  trend,
  edge: edge.toFixed(1),
  quality,
  atmStrike: atm.Strike,
  atmLTP: atm.LTP,
  intraStrike: intraday.Strike,
  intraLTP: intraday.LTP,
  swingStrike: swing.Strike,
  swingLTP: swing.LTP,
  summary,
  delta: atm.Delta,
  oi: atm.OIChgP,
  vol: atm.VolChg,
  iv: atm.IV,
  type: "PUT",
  heatBar: heat.bar,
  heatPct: heat.pct,
  buildup: atm.Buildup
};

document.getElementById("viewBox").value =
  (sentiment === "Bearish" && trend === "Down")
    ? "PUT / BEAR SPREAD"
    : "PUT (WEAK CONTEXT)";

waBtn.style.display = "inline-block";
document.getElementById("downloadBtn").style.display = "inline-block";
}

/* ===============================
          STRADDLE LOGIC
   =============================== */
if(name === "STRADDLE"){

const symbol = document.getElementById('symbolSelect').value;
const spot   = parseFloat(document.getElementById('spotInput').value);
const sentiment = document.getElementById('sentimentInput').value;
const trend = document.getElementById('trendInput').value;

if(!symbol || !spot){
  alert("Select symbol and enter spot");
  return;
}

const callRows = getCallRows(symbol);
const putRows  = getPutRows(symbol);

if(!callRows.length || !putRows.length){
  alert("Straddle data missing");
  return;
}

const atmCall = closestToSpot(callRows, spot);
const atmPut  = closestToSpot(putRows, spot);

/* ===== CORE METRICS ===== */
const totalPremium = (atmCall.LTP || 0) + (atmPut.LTP || 0);
const totalPremPct = (totalPremium / spot) * 100;

const edge = (
  computeEdgeScore(atmCall, atmCall.Strike) +
  computeEdgeScore(atmPut,  atmPut.Strike)
) / 2;

const quality = edge >= 7.5 ? "Strong" : edge >= 5.5 ? "Moderate" : "Weak";

/* ===== BREAKEVENS ===== */
const upsideBE   = atmCall.Strike + totalPremium;
const downsideBE = atmCall.Strike - totalPremium;

/* ===== VOLATILITY CONTEXT ===== */
const ivAvg = (
  (atmCall.IV != null ? atmCall.IV : 0) +
  (atmPut.IV  != null ? atmPut.IV  : 0)
) / 2;

const netDelta =
  (atmCall.Delta || 0) +
  (atmPut.Delta  || 0);

const DTE = calculateDTE(
  document.getElementById("expiryInput").value
) || 0;

const expMovePct = ivAvg > 0
  ? (ivAvg / 100) * Math.sqrt(DTE / 365) * 100
  : null;

/* ===== STRADDLE HEAT (NON-DIRECTIONAL) ===== */
const callOI = isFinite(atmCall.OIChgP) ? atmCall.OIChgP : 0;
const putOI  = isFinite(atmPut.OIChgP)  ? atmPut.OIChgP  : 0;
const avgOIChg = (callOI + putOI) / 2;

const activityScore = Math.min(
  100,
  Math.log10(Math.abs(avgOIChg) + 1) * 20
);

const straddleHeat = buildHeatBarFromConviction(activityScore);

/* ===== SUMMARY ===== */
const summary = [];

summary.push("Non-directional volatility structure");
summary.push(
  quality === "Strong"
    ? "Strong quality volatility setup"
    : quality === "Moderate"
      ? "Moderate quality â€” needs expansion"
      : "Weak quality â€” watchlist only"
);

summary.push(
  expMovePct >= totalPremPct
    ? "Expected move exceeds premium â€” expansion statistically supported"
    : "Premium exceeds expected move â€” requires stronger-than-average expansion"
);

summary.push(
  ivAvg < 20
    ? "IV compressed â€” favourable for long volatility"
    : ivAvg < 30
      ? "IV in balanced zone"
      : "IV elevated â€” contraction risk present"
);

/* ===== STWP FINAL ANALYSIS ===== */
const finalAnalysis = `
Momentum: Directionless | Trend: Neutral<br>
Risk: ${expMovePct >= totalPremPct ? "Statistically supported" : "Premium heavy"}<br>
Volatility: ${ivAvg < 20 ? "Favourable" : ivAvg < 30 ? "Balanced" : "Elevated"}<br>
Institutional Read: Positioning for range expansion<br>
Tactical View: Best suited before breakout or event-driven move
`;

/* ===== HORIZONTAL OUTPUT ===== */
const finalHTML = `
<div style="
  background:#ffffff;
  padding:12px 14px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  font-size:12px;
  line-height:1.4;
">

<b>SYMBOL:</b> ${symbol} |
<b>SPOT:</b> ${spot} |
<b>SENTIMENT:</b> ${sentiment} |
<b>TREND:</b> ${trend}<br>

<b>EDGE:</b> ${edge.toFixed(1)} / 10 (${quality}) |
<b>STRUCTURE:</b> Volatility (Non-directional)

<hr>

<b>STRIKES â†’</b>
ATM CALL ${atmCall.Strike} (${atmCall.LTP}) |
ATM PUT ${atmPut.Strike} (${atmPut.LTP})

<hr>

<b>PREMIUM & RANGE â†’</b>
Total Premium: ${totalPremium} (${totalPremPct.toFixed(2)}%) |
Upside BE: ${upsideBE.toFixed(2)} |
Downside BE: ${downsideBE.toFixed(2)}

<hr>

<b>INTERPRETATION â†’</b>
Net Î” ${netDelta.toFixed(2)} |
IV ${ivAvg.toFixed(2)}% |
Exp Move ${expMovePct?.toFixed(2)}%

<hr>

<b>SUMMARY â†’</b><br>
${summary.join(" | ")}

<hr>

<b>STWP FINAL ANALYSIS â†’</b><br>
${finalAnalysis}

<hr>

<b>STWP NOTE â†’</b>
Heat: ${straddleHeat.bar} ${straddleHeat.pct}% |
Pure volatility structure â€” direction irrelevant

</div>
`;

outputBox.style.display = "block";
outputBox.innerHTML = finalHTML;

/* ===== STORE FOR WHATSAPP ===== */
window.lastData = {
  type: "STRADDLE",
  symbol,
  spot,
  strike: atmCall.Strike,

  callLTP: atmCall.LTP,
  putLTP: atmPut.LTP,

  totalPremium,
  totalPremPct,

  upsideBE,
  downsideBE,

  ivAvg,
  netDelta,
  expMovePct,

  edge: edge.toFixed(1),
  quality,

  heatBar: straddleHeat.bar,
  heatPct: straddleHeat.pct
};

/* ===== AUTO VIEW ===== */
const bestView = decideBestView({
  trend,
  sentiment,
  ivAvg,
  expMovePct,
  totalPremPct,
  netDelta
});

document.getElementById("viewBox").value = bestView;

waBtn.style.display = "inline-block";
document.getElementById("downloadBtn").style.display = "inline-block";
}


/* ===============================
          STRANGLE LOGIC
   =============================== */
if(name === "STRANGLE"){

const symbol = document.getElementById('symbolSelect').value;
const spot   = parseFloat(document.getElementById('spotInput').value);
const sentiment = document.getElementById('sentimentInput').value;
const trend = document.getElementById('trendInput').value;

if(!symbol || !spot){
  alert("Select symbol and enter spot");
  return;
}

const callRows = getCallRows(symbol);
const putRows  = getPutRows(symbol);

if(!callRows.length || !putRows.length){
  alert("Strangle data missing");
  return;
}

/* ===== SELECT OTM LEGS ===== */
const otmCallList = callRows.filter(r => r.Strike > spot && r.Delta <= 0.35);
const otmPutList  = putRows.filter(r => r.Strike < spot && r.Delta >= -0.35);

const callLeg = otmCallList.length ? closestToSpot(otmCallList, spot) : null;
const putLeg  = otmPutList.length  ? closestToSpot(otmPutList, spot)  : null;

if(!callLeg || !putLeg){
  alert("No suitable OTM strikes for strangle");
  return;
}

/* ===== CORE METRICS ===== */
const totalPremium = (callLeg.LTP || 0) + (putLeg.LTP || 0);
const totalPremPct = (totalPremium / spot) * 100;

const edge = (
  computeEdgeScore(callLeg, callLeg.Strike) +
  computeEdgeScore(putLeg,  putLeg.Strike)
) / 2;

const quality = edge >= 7.0 ? "Strong" : edge >= 5.0 ? "Moderate" : "Weak";

/* ===== BREAKEVENS ===== */
const upsideBE   = callLeg.Strike + totalPremium;
const downsideBE = putLeg.Strike  - totalPremium;

/* ===== VOLATILITY CONTEXT ===== */
const ivAvg = (
  (callLeg.IV != null ? callLeg.IV : 0) +
  (putLeg.IV  != null ? putLeg.IV  : 0)
) / 2;

const netDelta =
  (callLeg.Delta || 0) +
  (putLeg.Delta  || 0);

const DTE = calculateDTE(
  document.getElementById("expiryInput").value
) || 0;

const expMovePct = ivAvg > 0
  ? (ivAvg / 100) * Math.sqrt(DTE / 365) * 100
  : null;

/* ===== STRANGLE HEAT (NON-DIRECTIONAL) ===== */
const avgOIChg = (
  (isFinite(callLeg.OIChgP) ? callLeg.OIChgP : 0) +
  (isFinite(putLeg.OIChgP)  ? putLeg.OIChgP  : 0)
) / 2;

const activityScore = Math.min(
  100,
  Math.log10(Math.abs(avgOIChg) + 1) * 20
);

const strangleHeat = buildHeatBarFromConviction(activityScore);

/* ===== SUMMARY ===== */
const summary = [];

summary.push("Lower-cost non-directional volatility structure");
summary.push(
  quality === "Strong"
    ? "Strong quality volatility setup"
    : quality === "Moderate"
      ? "Moderate quality â€” requires stronger expansion"
      : "Weak quality â€” watchlist only"
);

summary.push(
  expMovePct >= totalPremPct
    ? "Statistical expansion supports structure"
    : "Requires outsized move to justify premium"
);

summary.push(
  ivAvg < 22
    ? "IV compressed â€” favourable for strangle"
    : ivAvg < 30
      ? "IV balanced â€” neutral decay profile"
      : "IV elevated â€” contraction risk present"
);

/* ===== STWP FINAL ANALYSIS ===== */
const finalAnalysis = `
Momentum: Requires acceleration | Trend: Neutral<br>
Risk: ${expMovePct >= totalPremPct ? "Statistically supported" : "Premium sensitive"}<br>
Volatility: ${ivAvg < 22 ? "Favourable" : ivAvg < 30 ? "Balanced" : "Elevated"}<br>
Institutional Read: Tactical volatility positioning<br>
Tactical View: Prefer breakout or event-driven environments
`;

/* ===== HORIZONTAL OUTPUT ===== */
const finalHTML = `
<div style="
  background:#ffffff;
  padding:12px 14px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  font-size:12px;
  line-height:1.4;
">

<b>SYMBOL:</b> ${symbol} |
<b>SPOT:</b> ${spot} |
<b>SENTIMENT:</b> ${sentiment} |
<b>TREND:</b> ${trend}<br>

<b>EDGE:</b> ${edge.toFixed(1)} / 10 (${quality}) |
<b>STRUCTURE:</b> Volatility (Non-directional)

<hr>

<b>STRIKES â†’</b>
CALL ${callLeg.Strike} (${callLeg.LTP}) |
PUT ${putLeg.Strike} (${putLeg.LTP})

<hr>

<b>PREMIUM & RANGE â†’</b>
Total Premium: ${totalPremium} (${totalPremPct.toFixed(2)}%) |
Upside BE: ${upsideBE.toFixed(2)} |
Downside BE: ${downsideBE.toFixed(2)}

<hr>

<b>INTERPRETATION â†’</b>
Net Î” ${netDelta.toFixed(2)} |
IV ${ivAvg.toFixed(2)}% |
Exp Move ${expMovePct?.toFixed(2)}%

<hr>

<b>SUMMARY â†’</b><br>
${summary.join(" | ")}

<hr>

<b>STWP FINAL ANALYSIS â†’</b><br>
${finalAnalysis}

<hr>

<b>STWP NOTE â†’</b>
Heat: ${strangleHeat.bar} ${strangleHeat.pct}% |
Cost-efficient volatility expansion structure

</div>
`;

outputBox.style.display = "block";
outputBox.innerHTML = finalHTML;

/* ===== STORE FOR WHATSAPP ===== */
window.lastData = {
  type: "STRANGLE",
  symbol,
  spot,

  callStrike: callLeg.Strike,
  putStrike: putLeg.Strike,
  callLTP: callLeg.LTP,
  putLTP: putLeg.LTP,

  totalPremium,
  totalPremPct,

  upsideBE,
  downsideBE,

  ivAvg,
  netDelta,
  expMovePct,

  edge: edge.toFixed(1),
  quality,

  heatBar: strangleHeat.bar,
  heatPct: strangleHeat.pct
};

/* ===== AUTO VIEW ===== */
const bestView = decideBestView({
  trend,
  sentiment,
  ivAvg,
  expMovePct,
  totalPremPct,
  netDelta
});

document.getElementById("viewBox").value = bestView;

waBtn.style.display = "inline-block";
document.getElementById("downloadBtn").style.display = "inline-block";
}

/* ===============================
          BULL_SPREAD LOGIC
   =============================== */
if(name === "BULL_SPREAD"){

const symbol = document.getElementById('symbolSelect').value;
const spot   = parseFloat(document.getElementById('spotInput').value);
const sentiment = document.getElementById('sentimentInput').value;
const trend = document.getElementById('trendInput').value;

const calls = getCallRows(symbol).filter(
  r => r.Strike >= spot && r.Delta >= 0.35
);

if(calls.length < 2){
  alert("Not enough CALL strikes");
  return;
}

const buyCall  = closestToSpot(calls, spot);
const sellCall = calls.find(r => r.Strike > buyCall.Strike);

if(!sellCall){
  alert("Suitable spread legs not found");
  return;
}

/* ===== PAYOFF ===== */
const netDebit  = (buyCall.LTP || 0) - (sellCall.LTP || 0);
const maxProfit = (sellCall.Strike - buyCall.Strike) - netDebit;
const maxLoss   = netDebit;

/* ===== EDGE ===== */
const edge = (
  computeEdgeScore(buyCall,  buyCall.Strike) +
  computeEdgeScore(sellCall, sellCall.Strike)
) / 2;

const quality = edge >= 6 ? "Strong" : edge >= 4 ? "Moderate" : "Weak";

/* ===== BULL SPREAD HEAT ===== */
const activityScore = Math.min(
  100,
  Math.log10(
    Math.abs(buyCall.OIChgP || 0) +
    Math.abs(sellCall.OIChgP || 0) + 1
  ) * 15
);

const bullSpreadHeat = buildHeatBarFromConviction(activityScore);

/* ===== SUMMARY ===== */
const summary = [];

summary.push("Directional bullish structure with defined risk");
summary.push(
  quality === "Strong"
    ? "Strong quality spread â€” structure aligned"
    : quality === "Moderate"
      ? "Moderate quality â€” needs follow-through"
      : "Weak quality â€” watchlist only"
);

summary.push(
  netDebit < (sellCall.Strike - buyCall.Strike) / 2
    ? "Riskâ€“reward skew favourable"
    : "Reward capped â€” requires clean directional move"
);

summary.push(
  buyCall.OIChgP > sellCall.OIChgP
    ? "Long leg participation stronger than hedge"
    : "Hedge leg absorbing participation"
);

/* ===== STWP FINAL ANALYSIS ===== */
const finalAnalysis = `
Momentum: ${edge >= 6 ? "Supportive" : "Developing"} | Trend: ${trend}<br>
Risk: Defined and limited to net debit<br>
Volatility: Better suited when IV is elevated<br>
Institutional Read: Controlled bullish positioning<br>
Tactical View: Prefer spreads over naked CALL in uncertain momentum
`;

/* ===== HORIZONTAL OUTPUT ===== */
const finalHTML = `
<div style="
  background:#ffffff;
  padding:12px 14px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  font-size:12px;
  line-height:1.4;
">

<b>SYMBOL:</b> ${symbol} |
<b>SPOT:</b> ${spot} |
<b>SENTIMENT:</b> ${sentiment} |
<b>TREND:</b> ${trend}<br>

<b>EDGE:</b> ${edge.toFixed(1)} / 10 (${quality}) |
<b>STRUCTURE:</b> Directional (Risk-defined)

<hr>

<b>STRUCTURE â†’</b>
Buy CALL ${buyCall.Strike} (${buyCall.LTP}) |
Sell CALL ${sellCall.Strike} (${sellCall.LTP})

<hr>

<b>PAYOFF â†’</b>
Net Debit: ${netDebit.toFixed(2)} |
Max Profit: ${maxProfit.toFixed(2)} |
Max Loss: ${maxLoss.toFixed(2)}

<hr>

<b>INTERPRETATION â†’</b>
Î” Bias: Bullish |
Participation skew via long CALL |
Reward capped by design

<hr>

<b>SUMMARY â†’</b><br>
${summary.join(" | ")}

<hr>

<b>STWP FINAL ANALYSIS â†’</b><br>
${finalAnalysis}

<hr>

<b>STWP NOTE â†’</b>
Heat: ${bullSpreadHeat.bar} ${bullSpreadHeat.pct}% |
Safer alternative to naked CALL in high IV

</div>
`;

outputBox.style.display = "block";
outputBox.innerHTML = finalHTML;

/* ===== STORE FOR WHATSAPP ===== */
window.lastData = {
  type: "BULL_SPREAD",
  symbol,
  spot,

  buyStrike: buyCall.Strike,
  sellStrike: sellCall.Strike,
  buyLTP: buyCall.LTP,
  sellLTP: sellCall.LTP,

  netDebit,
  maxProfit,
  maxLoss,

  edge: edge.toFixed(1),
  quality,

  heatBar: bullSpreadHeat.bar,
  heatPct: bullSpreadHeat.pct
};

document.getElementById("viewBox").value = "BULL SPREAD";

waBtn.style.display = "inline-block";
document.getElementById("downloadBtn").style.display = "inline-block";
}

/* ===============================
          BEAR_SPREAD LOGIC
   =============================== */
if(name === "BEAR_SPREAD"){

const symbol = document.getElementById('symbolSelect').value;
const spot   = parseFloat(document.getElementById('spotInput').value);
const sentiment = document.getElementById('sentimentInput').value;
const trend = document.getElementById('trendInput').value;

const puts = getPutRows(symbol).filter(
  r => r.Strike <= spot && r.Delta <= -0.35
);

if(puts.length < 2){
  alert("Not enough PUT strikes");
  return;
}

const buyPut  = closestToSpot(puts, spot);
const sellPut = puts.find(r => r.Strike < buyPut.Strike);

if(!sellPut){
  alert("Suitable spread legs not found");
  return;
}

/* ===== PAYOFF ===== */
const netDebit  = (buyPut.LTP || 0) - (sellPut.LTP || 0);
const maxProfit = (buyPut.Strike - sellPut.Strike) - netDebit;
const maxLoss   = netDebit;

/* ===== EDGE ===== */
const edge = (
  computeEdgeScore(buyPut,  buyPut.Strike) +
  computeEdgeScore(sellPut, sellPut.Strike)
) / 2;

const quality = edge >= 6 ? "Strong" : edge >= 4 ? "Moderate" : "Weak";

/* ===== BEAR SPREAD HEAT ===== */
const activityScore = Math.min(
  100,
  Math.log10(
    Math.abs(buyPut.OIChgP || 0) +
    Math.abs(sellPut.OIChgP || 0) + 1
  ) * 15
);

const bearSpreadHeat = buildHeatBarFromConviction(activityScore);

/* ===== SUMMARY ===== */
const summary = [];

summary.push("Directional bearish structure with defined risk");
summary.push(
  quality === "Strong"
    ? "Strong quality spread â€” downside structure aligned"
    : quality === "Moderate"
      ? "Moderate quality â€” needs continuation"
      : "Weak quality â€” watchlist only"
);

summary.push(
  netDebit < (buyPut.Strike - sellPut.Strike) / 2
    ? "Riskâ€“reward skew favourable"
    : "Reward capped â€” requires clean downside follow-through"
);

summary.push(
  buyPut.OIChgP > sellPut.OIChgP
    ? "Long PUT participation stronger than hedge"
    : "Hedge leg absorbing participation"
);

/* ===== STWP FINAL ANALYSIS ===== */
const finalAnalysis = `
Momentum: ${edge >= 6 ? "Supportive" : "Developing"} | Trend: ${trend}<br>
Risk: Defined and limited to net debit<br>
Volatility: Better suited when IV is elevated<br>
Institutional Read: Controlled bearish positioning<br>
Tactical View: Prefer spreads over naked PUT in uncertain momentum
`;

/* ===== HORIZONTAL OUTPUT ===== */
const finalHTML = `
<div style="
  background:#ffffff;
  padding:12px 14px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  font-size:12px;
  line-height:1.4;
">

<b>SYMBOL:</b> ${symbol} |
<b>SPOT:</b> ${spot} |
<b>SENTIMENT:</b> ${sentiment} |
<b>TREND:</b> ${trend}<br>

<b>EDGE:</b> ${edge.toFixed(1)} / 10 (${quality}) |
<b>STRUCTURE:</b> Directional (Risk-defined)

<hr>

<b>STRUCTURE â†’</b>
Buy PUT ${buyPut.Strike} (${buyPut.LTP}) |
Sell PUT ${sellPut.Strike} (${sellPut.LTP})

<hr>

<b>PAYOFF â†’</b>
Net Debit: ${netDebit.toFixed(2)} |
Max Profit: ${maxProfit.toFixed(2)} |
Max Loss: ${maxLoss.toFixed(2)}

<hr>

<b>INTERPRETATION â†’</b>
Î” Bias: Bearish |
Downside participation via long PUT |
Reward capped by design

<hr>

<b>SUMMARY â†’</b><br>
${summary.join(" | ")}

<hr>

<b>STWP FINAL ANALYSIS â†’</b><br>
${finalAnalysis}

<hr>

<b>STWP NOTE â†’</b>
Heat: ${bearSpreadHeat.bar} ${bearSpreadHeat.pct}% |
Safer alternative to naked PUT in high IV

</div>
`;

outputBox.style.display = "block";
outputBox.innerHTML = finalHTML;

/* ===== STORE FOR WHATSAPP ===== */
window.lastData = {
  type: "BEAR_SPREAD",
  symbol,
  spot,

  buyStrike: buyPut.Strike,
  sellStrike: sellPut.Strike,
  buyLTP: buyPut.LTP,
  sellLTP: sellPut.LTP,

  netDebit,
  maxProfit,
  maxLoss,

  edge: edge.toFixed(1),
  quality,

  heatBar: bearSpreadHeat.bar,
  heatPct: bearSpreadHeat.pct
};

document.getElementById("viewBox").value = "BEAR SPREAD";

waBtn.style.display = "inline-block";
document.getElementById("downloadBtn").style.display = "inline-block";
}

/* ===============================
          IRON_CONDOR LOGIC
   =============================== */
if(name === "IRON_CONDOR"){

const symbol = document.getElementById('symbolSelect').value;
const spot   = parseFloat(document.getElementById('spotInput').value);
const sentiment = document.getElementById('sentimentInput').value;
const trend = document.getElementById('trendInput').value;

const calls = getCallRows(symbol);
const puts  = getPutRows(symbol);

/* ===== SELECT LEGS ===== */
const sellCall = calls.find(r => r.Strike > spot && r.Delta <= 0.20);
const buyCall  = calls.find(r => sellCall && r.Strike > sellCall.Strike);

const sellPut  = puts.find(r => r.Strike < spot && r.Delta >= -0.20);
const buyPut   = puts.find(r => sellPut && r.Strike < sellPut.Strike);

if(!sellCall || !buyCall || !sellPut || !buyPut){
  alert("Iron Condor legs not found");
  return;
}

/* ===== PAYOFF ===== */
const credit =
  (sellCall.LTP + sellPut.LTP) -
  (buyCall.LTP  + buyPut.LTP);

const width = Math.min(
  buyCall.Strike - sellCall.Strike,
  sellPut.Strike - buyPut.Strike
);

const maxLoss = width - credit;

/* ===== EDGE (AVG OF 4 LEGS) ===== */
const edge = (
  computeEdgeScore(sellCall, sellCall.Strike) +
  computeEdgeScore(buyCall,  buyCall.Strike) +
  computeEdgeScore(sellPut,  sellPut.Strike) +
  computeEdgeScore(buyPut,   buyPut.Strike)
) / 4;

const quality = edge >= 6 ? "Strong" : edge >= 4 ? "Moderate" : "Weak";

/* ===== IRON CONDOR HEAT ===== */
const avgOI =
  (
    (sellCall.OIChgP || 0) +
    (buyCall.OIChgP  || 0) +
    (sellPut.OIChgP  || 0) +
    (buyPut.OIChgP   || 0)
  ) / 4;

const activityScore = Math.min(
  100,
  Math.log10(Math.abs(avgOI) + 1) * 20
);

const ironCondorHeat = buildHeatBarFromConviction(activityScore);

/* ===== SUMMARY ===== */
const summary = [];

summary.push("Neutral income structure with defined risk");
summary.push(
  quality === "Strong"
    ? "Strong quality condor â€” range likely to hold"
    : quality === "Moderate"
      ? "Moderate quality â€” range must be respected"
      : "Weak quality â€” avoid aggressive sizing"
);

summary.push(
  ironCondorHeat.pct < 30
    ? "Positioning calm â€” supports range-bound behaviour"
    : "Positioning active â€” watch for expansion risk"
);

summary.push(
  trend === "Sideways"
    ? "Trend environment supportive for income strategies"
    : "Trend environment risky for range-bound structures"
);

/* ===== STWP FINAL ANALYSIS ===== */
const finalAnalysis = `
Momentum: Muted | Trend: ${trend}<br>
Risk: Defined but sharp expansion can hurt payoff<br>
Volatility: Best suited in falling or stable IV<br>
Institutional Read: Premium collection via range expectation<br>
Tactical View: Manage actively if price approaches wings
`;

/* ===== HORIZONTAL OUTPUT ===== */
const finalHTML = `
<div style="
  background:#ffffff;
  padding:12px 14px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  font-size:12px;
  line-height:1.4;
">

<b>SYMBOL:</b> ${symbol} |
<b>SPOT:</b> ${spot} |
<b>SENTIMENT:</b> ${sentiment} |
<b>TREND:</b> ${trend}<br>

<b>EDGE:</b> ${edge.toFixed(1)} / 10 (${quality}) |
<b>STRUCTURE:</b> Neutral Income (Risk-defined)

<hr>

<b>WINGS â†’</b>
CALL ${sellCall.Strike}/${buyCall.Strike} |
PUT ${sellPut.Strike}/${buyPut.Strike}

<hr>

<b>PAYOFF â†’</b>
Net Credit: ${credit.toFixed(2)} |
Max Loss: ${maxLoss.toFixed(2)}

<hr>

<b>INTERPRETATION â†’</b>
Range-bound expectation |
Theta-positive |
Expansion risk near wings

<hr>

<b>SUMMARY â†’</b><br>
${summary.join(" | ")}

<hr>

<b>STWP FINAL ANALYSIS â†’</b><br>
${finalAnalysis}

<hr>

<b>STWP NOTE â†’</b>
Heat: ${ironCondorHeat.bar} ${ironCondorHeat.pct}% |
Income-focused, manage aggressively on range breaks

</div>
`;

outputBox.style.display = "block";
outputBox.innerHTML = finalHTML;

/* ===== STORE FOR WHATSAPP ===== */
window.lastData = {
  type: "IRON_CONDOR",
  symbol,
  spot,

  callWing: `${sellCall.Strike}/${buyCall.Strike}`,
  putWing: `${sellPut.Strike}/${buyPut.Strike}`,

  credit,
  maxLoss,

  edge: edge.toFixed(1),
  quality,

  heatBar: ironCondorHeat.bar,
  heatPct: ironCondorHeat.pct
};

document.getElementById("viewBox").value = "IRON CONDOR";

waBtn.style.display = "inline-block";
document.getElementById("downloadBtn").style.display = "inline-block";
}

}
function formatNum(v, d=2){
    if(v == null || !isFinite(v)) return "n/a";
    return Number(v).toFixed(d);
}

function netDeltaView(delta){
    if(!isFinite(delta)) return "n/a";
    const a = Math.abs(delta);
    if(a < 0.10) return "Near neutral (pure volatility bet)";
    if(a < 0.25) return "Mild directional bias";
    return "Strong directional skew";
}

function premiumView(pct){
    if(!isFinite(pct)) return "Premium assessment unavailable.";
    if(pct > 2.5) return "Premium is on the richer side versus spot.";
    if(pct > 1.2) return "Premium is in a moderate, balanced zone.";
    return "Premium is relatively light versus spot.";
}

function ivView(iv){
    if(!isFinite(iv)) return "IV data unavailable.";
    if(iv > 35) return "IV is elevated, indicating event-driven or risk pricing.";
    if(iv >= 18) return "IV sits in a healthy middle band.";
    return "IV is on the lower side, indicating calm conditions.";
}

function exportWhatsApp() {

if (!window.lastData) {
    alert("No data to export!");
    return;
}

const d = window.lastData;
if(d.type === "BULL_SPREAD"){

const now = new Date().toLocaleString();

const msg =
`STWP BULLISH SPREAD ANALYSIS
Generated: ${now}
------------------------------------------------------------

Symbol: ${d.symbol}
Spot: ${formatNum(d.spot,2)}

Structure:
Buy CALL: ${d.buyStrike}
Sell CALL: ${d.sellStrike}

Net Debit Paid: ${formatNum(d.netDebit,2)}
Maximum Profit: ${formatNum(d.maxProfit,2)}
Maximum Loss: ${formatNum(d.maxLoss,2)}

Edge Score: ${d.edge}/10
Quality: ${d.quality}

STWP View:
â€¢ Bullish, risk-defined structure
â€¢ Better than naked CALL in high IV
â€¢ Limited reward but controlled risk
â€¢ Requires directional follow-through

------------------------------------------------------------
Note: Displayed option premiums represent a momentary market snapshot and are subject to continuous change as market conditions evolve.   
DISCLAIMER: This analysis is generated strictly for educational and analytical purposes only.  
All option structures, metrics, scores, interpretations, PCR, Max Pain levels, and volatility commentary are model-based observations derived from uploaded data.  
This does NOT constitute investment advice, trading advice, or a recommendation to buy or sell any security or derivative instrument.  
Options trading involves substantial risk and may not be suitable for all participants.  
Readers are advised to exercise independent judgment and consult a SEBI-registered financial advisor before taking any trading or investment decisions.  
STWP assumes no responsibility for any financial loss arising from the use of this analysis. `;
navigator.clipboard.writeText(msg);
alert("STWP Bullish Spread WhatsApp message copied!");
return;
}

if(d.type === "BEAR_SPREAD"){

const now = new Date().toLocaleString();

const msg =
`STWP BEARISH SPREAD ANALYSIS
Generated: ${now}
------------------------------------------------------------

Symbol: ${d.symbol}
Spot: ${formatNum(d.spot,2)}

Structure:
Buy PUT: ${d.buyStrike}
Sell PUT: ${d.sellStrike}

Net Debit Paid: ${formatNum(d.netDebit,2)}
Maximum Profit: ${formatNum(d.maxProfit,2)}
Maximum Loss: ${formatNum(d.maxLoss,2)}

Edge Score: ${d.edge}/10
Quality: ${d.quality}

STWP View:
â€¢ Bearish, risk-defined structure
â€¢ Lower decay impact than naked PUT
â€¢ Works best in controlled downside moves
â€¢ Avoid during sharp IV contraction

------------------------------------------------------------
Note: Displayed option premiums represent a momentary market snapshot and are subject to continuous change as market conditions evolve.   
DISCLAIMER: This analysis is generated strictly for educational and analytical purposes only.  
All option structures, metrics, scores, interpretations, PCR, Max Pain levels, and volatility commentary are model-based observations derived from uploaded data.  
This does NOT constitute investment advice, trading advice, or a recommendation to buy or sell any security or derivative instrument.  
Options trading involves substantial risk and may not be suitable for all participants.  
Readers are advised to exercise independent judgment and consult a SEBI-registered financial advisor before taking any trading or investment decisions.  
STWP assumes no responsibility for any financial loss arising from the use of this analysis. `;
navigator.clipboard.writeText(msg);
alert("STWP Bearish Spread WhatsApp message copied!");
return;
}

if(d.type === "IRON_CONDOR"){

const now = new Date().toLocaleString();

const msg =
`STWP IRON CONDOR ANALYSIS
Generated: ${now}
------------------------------------------------------------

Symbol: ${d.symbol}
Spot: ${formatNum(d.spot,2)}

Structure:
Call Wing: ${d.callWing || "OTM"} 
Put Wing: ${d.putWing || "OTM"}

Net Credit Received: ${formatNum(d.credit,2)}
Maximum Loss (Defined): ${formatNum(d.maxLoss,2)}

Market Nature:
â€¢ Range-bound
â€¢ Low momentum
â€¢ Falling or stable IV preferred

STWP View:
â€¢ Neutral income strategy
â€¢ Theta-positive structure
â€¢ Needs strict risk management
â€¢ Avoid during breakout or news phases

------------------------------------------------------------
Note: Displayed option premiums represent a momentary market snapshot and are subject to continuous change as market conditions evolve.   
DISCLAIMER: This analysis is generated strictly for educational and analytical purposes only.  
All option structures, metrics, scores, interpretations, PCR, Max Pain levels, and volatility commentary are model-based observations derived from uploaded data.  
This does NOT constitute investment advice, trading advice, or a recommendation to buy or sell any security or derivative instrument.  
Options trading involves substantial risk and may not be suitable for all participants.  
Readers are advised to exercise independent judgment and consult a SEBI-registered financial advisor before taking any trading or investment decisions.  
STWP assumes no responsibility for any financial loss arising from the use of this analysis. `;
navigator.clipboard.writeText(msg);
alert("STWP Iron Condor WhatsApp message copied!");
return;
}

if(d.type === "STRANGLE"){

const now = new Date().toLocaleString();

const msg =
`STWP STRANGLE ANALYSIS
Generated: ${now}
------------------------------------------------------------

Symbol: ${d.symbol}
Spot: ${formatNum(d.spot,2)}

CALL Strike: ${d.callStrike} | Premium: ${formatNum(d.callLTP,2)}
PUT Strike: ${d.putStrike} | Premium: ${formatNum(d.putLTP,2)}

Total Premium: ${formatNum(d.totalPremium,2)}
Expected Move %: ${formatNum(d.expMovePct,2)}%
Average IV: ${formatNum(d.ivAvg,2)}%
Net Delta: ${formatNum(d.netDelta,2)}

Breakevens:
Upside BE: ${formatNum(d.upsideBE,2)}
Downside BE: ${formatNum(d.downsideBE,2)}

Edge Score: ${d.edge}/10
Quality: ${d.quality}

STWP View:
â€¢ Lower cost volatility structure
â€¢ Requires stronger price expansion
â€¢ Best suited when IV is compressed
â€¢ Time decay is slower vs straddle

------------------------------------------------------------
Note: Displayed option premiums represent a momentary market snapshot and are subject to continuous change as market conditions evolve.   
DISCLAIMER: This analysis is generated strictly for educational and analytical purposes only.  
All option structures, metrics, scores, interpretations, PCR, Max Pain levels, and volatility commentary are model-based observations derived from uploaded data.  
This does NOT constitute investment advice, trading advice, or a recommendation to buy or sell any security or derivative instrument.  
Options trading involves substantial risk and may not be suitable for all participants.  
Readers are advised to exercise independent judgment and consult a SEBI-registered financial advisor before taking any trading or investment decisions.  
STWP assumes no responsibility for any financial loss arising from the use of this analysis. `;
navigator.clipboard.writeText(msg);
alert("STWP Strangle WhatsApp message copied!");
return;
}

/* ===============================
      STRADDLE WHATSAPP EXPORT
   =============================== */
if(d.type === "STRADDLE"){

const now = new Date().toLocaleString();

const msg =
`STWP STRADDLE ANALYSIS REPORT
Generated: ${now}
View: ${d.symbol} | ATM-only: ON
------------------------------------------------------------

STRADDLE ANALYSIS â€“ ${d.symbol} ${d.strike}
Spot: ${formatNum(d.spot,2)}
Call Premium: ${formatNum(d.callLTP,2)}
Put Premium: ${formatNum(d.putLTP,2)}
Total Premium %: ${formatNum(d.totalPremPct,2)}%
Expected Move %: ${formatNum(d.expMovePct,2)}%
Average IV: ${formatNum(d.ivAvg,2)}%
Net Delta: ${formatNum(d.netDelta,2)}
PCR (symbol-level): ${formatNum(d.pcr,2)}
Max Pain (symbol-level): ${d.maxPain}
Verdict: ${d.quality}
Score: ${d.edge}/10
Breakeven Levels:
Upside BE: ${formatNum(d.upsideBE,2)}
Downside BE: ${formatNum(d.downsideBE,2)}
Required Move: ${formatNum(d.upsideBE - d.strike,2)} points

Why this straddle behaves the way it does:
â€¢ ${premiumView(d.totalPremPct)}
â€¢ ${ivView(d.ivAvg)}
â€¢ ${d.expMovePct >= d.totalPremPct 
    ? "The statistically expected move is greater than or equal to the premium. This favours long-volatility traders."
    : "Expected move is lower than the premium, requiring stronger expansion to justify the cost."}
â€¢ Net delta assessment: ${netDeltaView(d.netDelta)}
â€¢ ${
    d.pcr == null
        ? "PCR data unavailable. OI-based positioning cannot be reliably assessed."
        : d.pcr < 0.8
            ? "PCR is low. Call writing is heavier, often seen when upside expectations are capped."
            : d.pcr > 1.2
                ? "PCR is high. Put writing dominates, indicating downside confidence."
                : "PCR is neutral, indicating balanced positioning."
}
â€¢ ${
    d.maxPain == null || d.spot == null
        ? "Max Pain relationship to spot cannot be evaluated."
        : Math.abs(d.maxPain - d.spot) > Math.abs(d.strike - d.spot)
            ? "Max Pain is away from current spot. There is room for genuine trending moves."
            : "Max Pain is near spot, which may magnetize price into expiry."
}


Overall STWP View:
${
    d.edge >= 7.5 && d.expMovePct >= d.totalPremPct
        ? "â€¢ Structure strongly supports a long-volatility strategy with statistical backing.\nâ€¢ Suitable as a primary volatility setup."
        : d.edge >= 5.5
            ? "â€¢ Setup is mixed. Volatility pricing requires expansion beyond current statistical expectations.\nâ€¢ Best treated as a conditional or watchlist volatility setup."
            : "â€¢ Conditions do not favour long straddle buyers at this stage.\nâ€¢ Risk-reward is unfavourable without a volatility catalyst."
}

Note: Displayed option premiums represent a momentary market snapshot and are subject to continuous change as market conditions evolve. 
DISCLAIMER: This analysis is generated strictly for educational and analytical purposes only. 
All option structures, metrics, scores, interpretations, PCR, Max Pain levels, and volatility commentary are model-based observations derived from uploaded data. 
This does NOT constitute investment advice, trading advice, or a recommendation to buy or sell any security or derivative instrument. 
Options trading involves substantial risk and may not be suitable for all participants. 
Readers are advised to exercise independent judgment and consult a SEBI-registered financial advisor before taking any trading or investment decisions. 
STWP assumes no responsibility for any financial loss arising from the use of this analysis.
------------------------------------------------------------`;

navigator.clipboard.writeText(msg);
alert("STWP Straddle WhatsApp message copied!");
return;
}

/* ===============================
      CALL / PUT â€” DETAILED EXPORT
   =============================== */

const now = new Date().toLocaleString();

// --- Delta Interpretation ---
let deltaView = "n/a";
if (isFinite(d.delta)) {
    const ad = Math.abs(d.delta);
    if (ad >= 0.55) deltaView = "High delta â€” aggressive directional exposure";
    else if (ad >= 0.40) deltaView = "Balanced delta â€” efficient directional exposure";
    else deltaView = "Low delta â€” momentum dependent";
}

// --- OI + Price Behaviour ---
let oiView = "OI behaviour unclear.";
if (d.oi != null && d.summary) {
    if (d.summary.some(s => s.includes("continuation")))
        oiView = "Price and OI are aligned â€” continuation structure.";
    else if (d.summary.some(s => s.includes("short covering")))
        oiView = "Short covering driven move â€” follow-through required.";
    else if (d.summary.some(s => s.includes("counter-trend")))
        oiView = "Counter-trend positioning â€” higher risk setup.";
}

// --- IV Regime ---
let ivViewDir = "IV regime neutral.";
if (isFinite(d.iv)) {
    if (d.iv < 18) ivViewDir = "IV is low â€” decay is slower, momentum required.";
    else if (d.iv > 35) ivViewDir = "IV is elevated â€” risk of volatility contraction.";
    else ivViewDir = "IV sits in a healthy middle band.";
}

const msg =
`STWP DIRECTIONAL OPTIONS ANALYSIS
Generated: ${now}
View: ${d.symbol} | ${d.type} Structure
------------------------------------------------------------

TRADE SNAPSHOT â€“ ${d.symbol} ${d.type}
Spot: ${d.spot}
Sentiment: ${d.sentiment}
Trend: ${d.trend}

Selected Strike: ${d.atmStrike}
Option LTP: ${d.atmLTP}

------------------------------------------------------------

POSITIONING & PARTICIPATION
Delta: ${d.delta} â†’ ${deltaView}
OI Change: ${d.oi}%
Volume Change: ${d.vol}%
Buildup Type: ${d.buildup || "Not available"}

Interpretation:
â€¢ ${oiView}

------------------------------------------------------------

STRUCTURE QUALITY METRICS
Edge Score: ${d.edge}/10
Setup Quality: ${d.quality}

Why this setup scores this way:
â€¢ Strike is positioned close to ATM for liquidity
â€¢ Delta profile supports directional exposure
â€¢ OI and volume indicate participation strength
â€¢ ${ivViewDir}

------------------------------------------------------------

RISK & BEHAVIOUR NOTES
â€¢ Directional options are sensitive to time decay
â€¢ Momentum continuation is essential for payoff
â€¢ Sideways price action will erode premium
â€¢ Position sizing discipline is critical

------------------------------------------------------------

OVERALL STWP VIEW:
${
    d.quality === "Strong"
        ? "â€¢ High-conviction directional structure with institutional alignment."
        : d.quality === "Moderate"
            ? "â€¢ Tradable setup with discipline; avoid over-sizing."
            : "â€¢ Structure lacks confirmation; best kept on watchlist."
}
------------------------------------------------------------
Note: Displayed option premiums represent a momentary market snapshot and are subject to continuous change as market conditions evolve.   
DISCLAIMER: This analysis is generated strictly for educational and analytical purposes only.  
All option structures, metrics, scores, interpretations, PCR, Max Pain levels, and volatility commentary are model-based observations derived from uploaded data.  
This does NOT constitute investment advice, trading advice, or a recommendation to buy or sell any security or derivative instrument.  
Options trading involves substantial risk and may not be suitable for all participants.  
Readers are advised to exercise independent judgment and consult a SEBI-registered financial advisor before taking any trading or investment decisions.  
STWP assumes no responsibility for any financial loss arising from the use of this analysis. `;
navigator.clipboard.writeText(msg);
alert(`STWP ${d.type} WhatsApp message copied!`);
}
function renderCSVTable(symbol){
  const wrapper = document.getElementById("csvTableWrapper");
  const table   = document.getElementById("csvTable");

  if(!symbol || fullCSVRows.length < 2){
    wrapper.style.display = "none";
    return;
  }

  const headers = fullCSVRows[0];
  const rows = fullCSVRows.slice(1)
    .filter(r => (r[0] || "").trim().toUpperCase() === symbol);

  if(!rows.length){
    wrapper.style.display = "none";
    return;
  }

  let html = "<thead><tr>";
  headers.forEach(h=>{
    html += `<th style="
      border:1px solid #e1e4ea;
      padding:4px 6px;
      background:#f2f4f8;
      font-weight:600;
    ">${h}</th>`;
  });
  html += "</tr></thead><tbody>";

  rows.forEach(r=>{

  const type = (r[1] || "").toUpperCase();
  const rowClass =
    type === "CE" || type === "CALL" ? "call-row" :
    type === "PE" || type === "PUT"  ? "put-row"  : "";

  html += `<tr class="${rowClass}">`;
    headers.forEach((h,i)=>{

  let cell = r[i] ?? "";
  let cls  = "";

  const header = h.toLowerCase();

  // OI Change %
  if(header.includes("oi chg%")){
    const v = parseFloat(cell);
    if(!isNaN(v)) cls = v >= 0 ? "pos" : "neg";
  }

  // Delta proximity highlighting (near Â±0.50)
if(header === "delta"){
  const d = parseFloat(cell);
  if(isFinite(d)){
    const ad = Math.abs(d);

    if(ad >= 0.45 && ad <= 0.55){
      cls = "delta-strong";      // Near ATM
    }
    else if(ad >= 0.30 && ad < 0.45){
      cls = "delta-medium";     // Moderate
    }
  }
}


  // Buildup badge â€” DETAILED MARKET LOGIC
if(header === "buildup"){
  const b = String(cell).toLowerCase();

  if(b.includes("long build")){
    cell = `<span class="badge badge-long-build">${cell}</span>`;
  }
  else if(b.includes("short cover")){
    cell = `<span class="badge badge-short-cover">${cell}</span>`;
  }
  else if(b.includes("short build")){
    cell = `<span class="badge badge-short-build">${cell}</span>`;
  }
  else if(b.includes("long unwind")){
    cell = `<span class="badge badge-long-unwind">${cell}</span>`;
  }
}


  html += `<td class="${cls}" style="
    border:1px solid #e1e4ea;
    padding:4px 6px;
  ">${cell}</td>`;
});

    html += "</tr>";
  });

  html += "</tbody>";

  table.innerHTML = html;
  wrapper.style.display = "block";
}
function calculateDTE(expiryDateStr){
  if(!expiryDateStr) return null;

  const today = new Date();
  today.setHours(0,0,0,0);

  const expiry = new Date(expiryDateStr);
  expiry.setHours(0,0,0,0);

  const diffMs = expiry - today;
  const dte = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

  return dte >= 0 ? dte : 0;
}

/* ===============================
   VIEW AUTO-REFRESH HOOKS
================================ */
["symbolSelect", "sentimentInput", "trendInput", "expiryInput"]
.forEach(id => {
  document.getElementById(id).addEventListener(
    "change",
    refreshViewBox
  );
});

document.getElementById("expiryInput").addEventListener("change", () => {
  const expiry = document.getElementById("expiryInput").value;
  const dte = calculateDTE(expiry);

  document.getElementById("dteInput").value =
    dte != null ? `${dte} days` : "";

  // ðŸ”‘ Refresh View once DTE is known
  refreshViewBox();
});

</script>

<footer class="stwp-disclaimer">
  <strong>Disclaimer:</strong>
  This tool is provided strictly for <b>educational and analytical purposes</b> only.
  All option structures, views, scores, and interpretations displayed are
  <b>model-based observations</b> derived from uploaded market data.
  This does <b>not</b> constitute investment advice, trading advice, or a recommendation
  to buy or sell any security or derivative.
  Options trading involves risk and may not be suitable for all participants.
  Users must exercise independent judgment and consult a
  <b>SEBI-registered financial advisor</b> before making any trading or investment decisions.
  STWP assumes no responsibility for any financial loss arising from the use of this tool.
</footer>
<div id="csvTableWrapper" style="
  margin:20px;
  background:#ffffff;
  padding:14px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  font-size:11px;
  display:none;
">
  <div style="font-weight:700; margin-bottom:8px;">
    Options Chain Data â€” As Uploaded (CSV View)
  </div>
  <div style="overflow-x:auto;">
    <table id="csvTable" style="
      border-collapse:collapse;
      width:100%;
      white-space:nowrap;
    "></table>
  </div>
</div>

</body>
</html>

